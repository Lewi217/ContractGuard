#name: CD - Deploy to Production
#
#on:
#  push:
#    branches:
#      - main
#  workflow_dispatch:
#
#env:
#  REGISTRY: ghcr.io
#  IMAGE_NAME: ${{ github.repository }}
#
#jobs:
#  build-and-push:
#    name: Build and Push Docker Image
#    runs-on: ubuntu-latest
#
#    permissions:
#      contents: read
#      packages: write
#
#    outputs:
#      image-tag: ${{ steps.meta.outputs.tags }}
#      image-digest: ${{ steps.build.outputs.digest }}
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Set up Docker Buildx
#        uses: docker/setup-buildx-action@v3
#
#      - name: Log in to GitHub Container Registry
#        uses: docker/login-action@v3
#        with:
#          registry: ${{ env.REGISTRY }}
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: Extract metadata
#        id: meta
#        uses: docker/metadata-action@v5
#        with:
#          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
#          tags: |
#            type=ref,event=branch
#            type=sha,prefix={{branch}}-
#            type=raw,value=latest,enable={{is_default_branch}}
#            type=semver,pattern={{version}}
#            type=semver,pattern={{major}}.{{minor}}
#
#      - name: Build and push Docker image
#        id: build
#        uses: docker/build-push-action@v5
#        with:
#          context: .
#          file: ./Dockerfile
#          target: production
#          push: true
#          tags: ${{ steps.meta.outputs.tags }}
#          labels: ${{ steps.meta.outputs.labels }}
#          cache-from: type=gha
#          cache-to: type=gha,mode=max
#          build-args: |
#            BUILD_DATE=${{ github.event.head_commit.timestamp }}
#            VCS_REF=${{ github.sha }}
#            VERSION=${{ github.ref_name }}
#
#      - name: Scan image for vulnerabilities
#        uses: aquasecurity/trivy-action@master
#        with:
#          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
#          format: 'sarif'
#          output: 'trivy-image-results.sarif'
#
#      - name: Upload Trivy results
#        uses: github/codeql-action/upload-sarif@v2
#        if: always()
#        with:
#          sarif_file: 'trivy-image-results.sarif'
#
#  deploy-to-vm:
#    name: Deploy to Azure VM
#    runs-on: ubuntu-latest
#    needs: build-and-push
#    environment:
#      name: production
#      url: https://${{ secrets.DOMAIN_NAME }}
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Deploy to Azure VM
#        uses: appleboy/ssh-action@v1.0.0
#        with:
#          host: ${{ secrets.AZURE_VM_HOST }}
#          username: ${{ secrets.AZURE_VM_USERNAME }}
#          key: ${{ secrets.AZURE_VM_SSH_KEY }}
#          port: ${{ secrets.AZURE_VM_PORT || 22 }}
#          script_stop: true
#          script: |
#            set -e
#
#            echo "=== Starting Deployment ==="
#
#            # Navigate to application directory
#            cd /opt/contractguard
#
#            # Pull latest code
#            echo "Pulling latest code..."
#            git pull origin main
#
#            # Login to GitHub Container Registry
#            echo "Logging in to GitHub Container Registry..."
#            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
#
#            # Pull latest image
#            echo "Pulling latest Docker image..."
#            docker compose -f docker-compose.prod.yml pull
#
#            # Stop old containers
#            echo "Stopping old containers..."
#            docker compose -f docker-compose.prod.yml down
#
#            # Start new containers
#            echo "Starting new containers..."
#            docker compose -f docker-compose.prod.yml up -d
#
#            # Wait for application to be ready
#            echo "Waiting for application to start..."
#            sleep 15
#
#            # Health check
#            echo "Running health check..."
#            max_attempts=10
#            attempt=1
#
#            while [ $attempt -le $max_attempts ]; do
#              if curl -f http://localhost:8080/actuator/health; then
#                echo "Health check passed!"
#                break
#              else
#                echo "Attempt $attempt/$max_attempts failed, retrying..."
#                attempt=$((attempt + 1))
#                sleep 5
#              fi
#            done
#
#            if [ $attempt -gt $max_attempts ]; then
#              echo "Health check failed after $max_attempts attempts"
#              docker compose -f docker-compose.prod.yml logs --tail=50
#              exit 1
#            fi
#
#            # Clean up old images
#            echo "Cleaning up old Docker images..."
#            docker image prune -af --filter "until=24h"
#
#            echo "=== Deployment Complete ==="
#
#            # Show running containers
#            docker ps
#
#      - name: Verify deployment
#        run: |
#          echo "Verifying deployment..."
#          # Add additional verification steps here
#          # For example, run smoke tests, check metrics, etc.
#
#      - name: Rollback on failure
#        if: failure()
#        uses: appleboy/ssh-action@v1.0.0
#        with:
#          host: ${{ secrets.AZURE_VM_HOST }}
#          username: ${{ secrets.AZURE_VM_USERNAME }}
#          key: ${{ secrets.AZURE_VM_SSH_KEY }}
#          script: |
#            echo "=== Rolling back deployment ==="
#            cd /opt/contractguard
#
#            # Get previous image tag (you may need to adjust this)
#            docker compose -f docker-compose.prod.yml down
#            # Pull previous stable image
#            # docker compose -f docker-compose.prod.yml up -d
#
#            echo "Rollback complete"
#
#      - name: Notify deployment status
#        if: always()
#        uses: 8398a7/action-slack@v3
#        with:
#          status: ${{ job.status }}
#          text: |
#            Deployment Status: ${{ job.status }}
#            Repository: ${{ github.repository }}
#            Branch: ${{ github.ref_name }}
#            Commit: ${{ github.sha }}
#            Author: ${{ github.actor }}
#          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
#        env:
#          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
#
#  post-deployment:
#    name: Post Deployment Tasks
#    runs-on: ubuntu-latest
#    needs: deploy-to-vm
#    if: success()
#
#    steps:
#      - name: Create deployment record
#        uses: actions/github-script@v7
#        with:
#          script: |
#            github.rest.repos.createDeployment({
#              owner: context.repo.owner,
#              repo: context.repo.repo,
#              ref: context.sha,
#              environment: 'production',
#              description: 'Deployed to Azure VM',
#              auto_merge: false,
#              required_contexts: []
#            })
#
#      - name: Run smoke tests
#        run: |
#          echo "Running smoke tests..."
#          # Add your smoke test commands here
#          # curl -f https://your-domain.com/api/health
#
#      - name: Update monitoring
#        run: |
#          echo "Updating monitoring dashboards..."
#          # Trigger monitoring updates if needed